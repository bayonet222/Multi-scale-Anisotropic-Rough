#! /usr/bin/env python
#  -*- coding: utf-8 -*-
#
# Support module generated by PAGE version 4.14
# In conjunction with Tcl version 8.6
#    Aug 09, 2018 03:09:08 PM


import sys
import cStringIO
import numpy as np
from time import strftime, gmtime

# First we should tell matplotlib that we are using a tkinter based GUI.
# Otherwise there might be backend conflicts which would cause the main
# window to freeze until matplotlib plots are closed. MARS import should
# happen after this setting too.
import matplotlib
matplotlib.use('TkAgg')
import matplotlib.pyplot as plt

import mars

try:
    from Tkinter import *
    import tkFileDialog
except ImportError:
    from tkinter import *

try:
    import ttk
    py3 = False
except ImportError:
    import tkinter.ttk as ttk
    py3 = True
    
def set_Tk_var():
    global N
    N = StringVar()
    N.set(128)
    global M
    M = StringVar()
    M.set(128)
    global dx
    dx = StringVar()
    dx.set(1)
    global dy
    dy = StringVar()
    dy.set(1)
    global attempts
    attempts = StringVar()
    attempts.set(1)
    global rmsheight
    rmsheight = StringVar()
    rmsheight.set(1)
    global skewness
    skewness = StringVar()
    skewness.set(0.5)
    global kurtosis
    kurtosis = StringVar()
    kurtosis.set(3.5)
    global acf_type
    acf_type = StringVar()
    global n
    n = StringVar()
    n.set(16)
    global m
    m = StringVar()
    m.set(16)
    global phi
    phi = StringVar()
    phi.set(0.0)

def update_box(box, stream, root):
    ### --- Function to add text to the output box in the GUI --- ###
    if len(stream.getvalue())>0:
            box.configure(state=NORMAL)
            time_stamp = strftime('%H:%M', gmtime())
            new_text = "["+time_stamp + "] " + stream.getvalue()
            box.insert(END, new_text)
            box.configure(state=DISABLED)
            root.update_idletasks()
            box.see(END)        
            stream.truncate(0)


def generate_surface(box, root):
    global N, M, dx, dy, attempts, rmsheight, skewness, kurtosis, acf_type
    global n, m, phi
    global hmap

    ### TO DO: Change this once you add support for advanced settings
    cutoff = 1e-5

    # Capture the stdoutput to a variable which then can be used to 
    # update the box that reports program updates.
    stdout_ = sys.stdout
    stream = cStringIO.StringIO()
    sys.stdout = stream

    # Repeat the surface generation steps however many times needed.
    for i in range(int(attempts.get())):

        s= mars.surface(
                int(n.get()), int(m.get()), int(N.get()), int(M.get()), \
                np.float64(cutoff), np.float64(dx.get()), \
                np.float64(dy.get()), np.float64(phi.get()))

        update_box(box, stream, root)

        print ("Attempting to generate a surface with Sk=" + skewness.get()\
               + " and Ku=" + kurtosis.get())

        update_box(box, stream, root)

        # Step 1: Specify ACF
        acf= s.acf()

        # Step 2: Assemble & solve nonlinear system of equations
        guess= s.f0()
        alpha= s.krylov(method="lgmres", plot=False)

        update_box(box, stream, root)

        # Step 3: Generate a random number matrix
        rescaled_skew, rescaled_kurt = s.rescale(
                alpha, np.float64(skewness.get()), \
                np.float64(kurtosis.get()))

        update_box(box, stream, root)

        if (np.isnan(rescaled_skew)) and (np.isnan(rescaled_kurt)):
            sys.exit("Error: The program can't generate the surface because of the input Skew and Kurtosis.")

        rand= s.johnson_eta(rescaled_skew, rescaled_kurt)
        update_box(box, stream, root)

        # Step 4: Generate the heightmap
        hmap= s.heightmap(alpha,rand)
        update_box(box, stream, root)

    # Restore stdout to initial state
    sys.stdout = stdout_
    
    # Plot the final surface with a colourbar
    plt.figure(2)
    plt.pcolormesh(range(int(N.get())), range(int(M.get())), hmap, cmap=plt.cm.RdYlBu_r)
    plt.title("Generated surface")
    plt.xlabel("Streamwise points")
    plt.ylabel("Spanwise points")
    plt.axis("tight")
    plt.colorbar()
    plt.show()
    

def save_as(self):
    global hmap
    self.f = tkFileDialog.asksaveasfilename(   
        filetypes = (("dat file", "*.dat"),    
                     ("CSV file", "*.csv")))
    with open(self.f, 'w') as outputFile:
        outputFile.write(hmap)

def init(top, gui, *args, **kwargs):
    global w, top_level, root
    w = gui
    top_level = top
    root = top

def destroy_window():
    # Function which closes the window.
    global top_level
    top_level.destroy()
    top_level = None

if __name__ == '__main__':
    import GUI
    GUI.vp_start_gui()


